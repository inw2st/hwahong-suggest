<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í™”í™ê³  í•™ìƒíšŒ ê±´ì˜í•¨ - ë‚´ ê±´ì˜</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Pretendard', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'] },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="/assets/theme.css" />
    <style>
      .hero-bg { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 60%, #2563eb 100%); }
      .float-in { animation: floatIn 0.4s ease both; }
      @keyframes floatIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body class="font-sans bg-slate-50 min-h-screen">

    <header class="sticky top-0 z-40 backdrop-blur bg-white/90 border-b border-slate-200 shadow-sm">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <a href="/" class="flex items-center gap-3 group">
          <img src="/assets/logo.png" alt="í™”í™ê³  ë¡œê³ " class="h-10 w-10 object-contain group-hover:scale-105 transition" />
          <div>
            <div class="text-sm font-bold text-slate-900 leading-none">í™”í™ê³ ë“±í•™êµ í•™ìƒíšŒ</div>
            <div class="text-xs text-blue-700 mt-0.5 font-medium">ê±´ì˜í•¨</div>
          </div>
        </a>
        <nav class="flex items-center gap-1">
          <a href="/" class="px-3 py-2 rounded-xl text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-700 transition font-medium">ê±´ì˜ ì‘ì„±</a>
          <a href="/admin/login.html" class="px-3 py-2 rounded-xl text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-700 transition font-medium">ê´€ë¦¬ì</a>
        </nav>
      </div>
    </header>

    <div class="hero-bg text-white py-10 px-4">
      <div class="max-w-5xl mx-auto flex items-center gap-6">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight">ë‚´ ê±´ì˜ ëª©ë¡</h1>
          <p class="text-blue-100 mt-1 text-sm md:text-base">ë‹µë³€ ìƒíƒœì™€ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</p>
        </div>
      </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-8">
      <section class="float-in">
        <div class="flex items-center justify-between gap-4 flex-wrap mb-6">
          <div class="rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 px-5 py-3 flex items-center gap-3">
            <span class="text-xs text-slate-500">ë‚´ ì‹ë³„í‚¤</span>
            <span id="studentKey" class="text-xs font-mono text-slate-700 select-all bg-slate-50 px-2 py-1 rounded-lg"></span>
          </div>
          <div class="flex items-center gap-2">
            <button id="refreshBtn" class="px-4 py-2 rounded-xl bg-white ring-1 ring-slate-200 text-sm font-semibold hover:bg-blue-50 hover:ring-blue-200 hover:text-blue-700 transition">ìƒˆë¡œê³ ì¹¨</button>
            <button id="notifyBtn" class="px-4 py-2 rounded-xl bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold shadow-sm hover:shadow-md transition">ì•Œë¦¼ ì„¤ì •</button>
            <span id="devButtons">
              <button id="resetWatermarkBtn" class="px-4 py-2 rounded-xl bg-amber-500 text-white text-sm font-semibold shadow-sm hover:shadow-md transition">ì›Œí„°ë§ˆí¬ ì´ˆê¸°í™”</button>
              <button id="testNotifyBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white text-sm font-semibold shadow-sm hover:shadow-md transition">í…ŒìŠ¤íŠ¸</button>
            </span>
          </div>
        </div>

        <div id="list" class="grid grid-cols-1 gap-5"></div>
      </section>
    </main>

    <footer class="mt-12 py-6 border-t border-slate-200 text-center text-xs text-slate-400">
      Â© í™”í™ê³ ë“±í•™êµ í•™ìƒíšŒ Â· ê±´ì˜í•¨
    </footer>

    <script src="/assets/app.js"></script>
    <script>
      const listEl = document.getElementById('list');
      const studentKeyEl = document.getElementById('studentKey');
      studentKeyEl.textContent = App.getStudentKey();

      const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (!isLocal) document.getElementById('devButtons').style.display = 'none';

      const VAPID_PUBLIC_KEY = 'BJpbfzPQdhyWeK9lv9Rs6S3bdqYZpgAUqTuw6j0-ME2sxXWM8THv4d1ZCow2BtjPoULAqJb5yy86mPkXly0Fqpc';

      let swRegistration = null;
      let pushSubscription = null;

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then((reg) => {
            swRegistration = reg;
            reg.pushManager.getSubscription().then((sub) => { if (sub) pushSubscription = sub; });
          })
          .catch((err) => console.log('SW ë“±ë¡ ì‹¤íŒ¨:', err));
      }

      async function subscribeToPush() {
        if (!swRegistration) return null;
        try {
          const sub = await swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          await App.apiFetch('/push/subscribe', {
            method: 'POST',
            body: { endpoint: sub.endpoint, p256dh: arrayBufferToBase64Url(sub.getKey('p256dh')), auth: arrayBufferToBase64Url(sub.getKey('auth')) }
          });
          pushSubscription = sub;
          return sub;
        } catch (e) { return null; }
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      function arrayBufferToBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      async function showNotification(title, body, tag) {
        if (swRegistration) {
          try { await swRegistration.showNotification(title, { body, icon: '/assets/logo.png', tag: tag || 'suggestion', requireInteraction: true }); return; } catch (e) {}
        }
        if (Notification.permission === 'granted') {
          try { new Notification(title, { body, icon: '/assets/logo.png', tag }); } catch (e) {}
        }
      }

      function badge(status) {
        const cls = status === 'answered' ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200' : 'bg-amber-50 text-amber-700 ring-1 ring-amber-200';
        const label = status === 'answered' ? 'âœ“ ë‹µë³€ì™„ë£Œ' : 'â³ ëŒ€ê¸°ì¤‘';
        return App.el('span', { class: `px-3 py-1 rounded-full text-xs font-semibold ${cls}` }, [label]);
      }

      function fmt(dt) {
        try { return new Date(dt).toLocaleString('ko-KR', { hour12: false }); } catch { return String(dt); }
      }

      function card(s) {
        const wrap = App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 overflow-hidden hover:shadow-lg transition duration-200' });
        const head = App.el('div', { class: 'px-6 py-5 border-b border-slate-100 flex items-start justify-between gap-4' });
        const title = App.el('div', {}, [
          App.el('div', { class: 'text-xs text-slate-500' }, [`${s.grade}í•™ë…„ Â· ${fmt(s.created_at)}`]),
          App.el('div', { class: 'text-lg font-bold text-slate-900 mt-1' }, [s.title]),
        ]);
        head.append(title, badge(s.status));

        const body = App.el('div', { class: 'px-6 py-5 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap' }, [s.content]);
        const actions = App.el('div', { class: 'px-6 py-4 bg-slate-50 flex items-center justify-between gap-4 flex-wrap' });
        const left = App.el('div', { class: 'text-xs text-slate-400' }, [`ì—…ë°ì´íŠ¸: ${fmt(s.updated_at)}`]);
        const btnRow = App.el('div', { class: 'flex items-center gap-2' });
        const editBtn = App.el('button', {
          class: 'px-4 py-2 rounded-xl bg-white ring-1 ring-slate-200 text-sm font-semibold hover:bg-blue-50 hover:ring-blue-200 hover:text-blue-700 transition disabled:opacity-40',
          disabled: s.status !== 'pending', onclick: () => openEdit(s),
        }, ['ìˆ˜ì •']);
        const delBtn = App.el('button', {
          class: 'px-4 py-2 rounded-xl bg-white ring-1 ring-slate-200 text-sm font-semibold hover:bg-red-50 hover:ring-red-200 hover:text-red-600 transition disabled:opacity-40',
          disabled: s.status !== 'pending', onclick: () => onDelete(s),
        }, ['ì‚­ì œ']);
        btnRow.append(editBtn, delBtn);
        actions.append(left, btnRow);
        wrap.append(head, body);

        if (s.status === 'answered' && s.answer) {
          const answer = App.el('div', { class: 'px-6 py-5 border-t border-blue-100 bg-blue-50' }, [
            App.el('div', { class: 'text-sm font-bold text-blue-900 flex items-center gap-1' }, ['ğŸ’¬ í•™ìƒíšŒ ë‹µë³€']),
            App.el('div', { class: 'text-xs text-blue-500 mt-1' }, [s.answered_at ? fmt(s.answered_at) : '']),
            App.el('div', { class: 'mt-3 rounded-2xl bg-white ring-1 ring-blue-200 p-4 text-sm text-slate-700 whitespace-pre-wrap' }, [s.answer]),
          ]);
          wrap.append(answer);
        }

        wrap.append(actions);
        return wrap;
      }

      async function load() {
        listEl.innerHTML = '<div class="text-sm text-slate-400 py-4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try {
          const items = await App.apiFetch('/me/suggestions');
          if (!items.length) {
            listEl.innerHTML = '';
            listEl.appendChild(App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-10 text-center' }, [
              App.el('div', { class: 'text-4xl mb-4' }, ['ğŸ“']),
              App.el('div', { class: 'text-lg font-bold text-slate-900' }, ['ì•„ì§ ì‘ì„±í•œ ê±´ì˜ê°€ ì—†ì–´ìš”.']),
              App.el('div', { class: 'text-sm text-slate-500 mt-2' }, ['ì²« ê±´ì˜ë¥¼ ì‘ì„±í•´ ë³´ì„¸ìš”.']),
              App.el('a', { href: '/', class: 'inline-flex mt-5 px-5 py-3 rounded-2xl bg-blue-700 text-white text-sm font-bold shadow-sm hover:bg-blue-800 transition' }, ['ê±´ì˜ ì‘ì„±í•˜ê¸°']),
            ]));
            return;
          }
          listEl.innerHTML = '';
          items.forEach((s) => listEl.appendChild(card(s)));
        } catch (err) {
          listEl.innerHTML = '';
          listEl.appendChild(App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-6 text-sm text-slate-600' }, [err.message || 'API ì˜¤ë¥˜']));
        }
      }

      function openEdit(s) {
        const overlay = App.el('div', { class: 'fixed inset-0 z-50 bg-slate-950/40 backdrop-blur-sm flex items-center justify-center p-4' });
        const card = App.el('div', { class: 'w-full max-w-lg rounded-3xl bg-white shadow-xl ring-1 ring-slate-200 overflow-hidden' });
        const head = App.el('div', { class: 'px-6 py-5 border-b border-slate-100 bg-blue-50 flex items-center justify-between' }, [
          App.el('div', { class: 'text-base font-bold text-slate-900' }, ['ê±´ì˜ ìˆ˜ì •']),
          App.el('button', { class: 'px-3 py-2 rounded-xl hover:bg-blue-100 transition text-sm', onclick: () => overlay.remove() }, ['ë‹«ê¸°']),
        ]);
        const grade = App.el('select', { class: 'w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100' },
          Array.from({ length: 3 }).map((_, i) => {
            const g = i + 1;
            const opt = document.createElement('option');
            opt.value = String(g); opt.textContent = `${g}í•™ë…„`;
            if (g === s.grade) opt.selected = true;
            return opt;
          })
        );
        const title = App.el('input', { value: s.title, class: 'w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100' });
        const content = App.el('textarea', { class: 'w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100', rows: '7' }, [s.content]);
        const body = App.el('div', { class: 'px-6 py-6 space-y-4' }, [
          App.el('div', {}, [App.el('div', { class: 'text-sm font-semibold text-slate-800 mb-2' }, ['í•™ë…„']), grade]),
          App.el('div', {}, [App.el('div', { class: 'text-sm font-semibold text-slate-800 mb-2' }, ['ì œëª©']), title]),
          App.el('div', {}, [App.el('div', { class: 'text-sm font-semibold text-slate-800 mb-2' }, ['ë‚´ìš©']), content]),
        ]);
        const saveBtn = App.el('button', { class: 'px-5 py-3 rounded-2xl bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold shadow-sm transition' }, ['ì €ì¥']);
        saveBtn.addEventListener('click', async () => {
          saveBtn.disabled = true; saveBtn.classList.add('opacity-60');
          try {
            await App.apiFetch(`/me/suggestions/${s.id}`, { method: 'PATCH', body: { grade: Number(grade.value), title: title.value, content: content.value } });
            App.toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            overlay.remove();
            await load();
          } catch (err) {
            App.toast(err.message || 'ìˆ˜ì • ì‹¤íŒ¨', 'error');
          } finally { saveBtn.disabled = false; saveBtn.classList.remove('opacity-60'); }
        });
        const foot = App.el('div', { class: 'px-6 py-5 bg-slate-50 flex items-center justify-end gap-2' }, [
          App.el('button', { class: 'px-4 py-2 rounded-2xl bg-white ring-1 ring-slate-200 text-sm font-semibold hover:bg-slate-50 transition', onclick: () => overlay.remove() }, ['ì·¨ì†Œ']),
          saveBtn,
        ]);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        card.append(head, body, foot);
        overlay.append(card);
        document.body.append(overlay);
      }

      async function onDelete(s) {
        if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
        try {
          await App.apiFetch(`/me/suggestions/${s.id}`, { method: 'DELETE' });
          App.toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          await load();
        } catch (err) { App.toast(err.message || 'ì‚­ì œ ì‹¤íŒ¨', 'error'); }
      }

      async function pollNewAnswers() {
        if (Notification.permission !== 'granted') return;
        try {
          const items = await App.apiFetch('/me/suggestions');
          const lastWatermark = localStorage.getItem('last_answered_at');
          const answered = items.filter((s) => s.status === 'answered' && s.answered_at);
          if (answered.length > 0) {
            const sortedAnswers = answered.map(s => ({ ...s, answeredAt: new Date(s.answered_at).getTime() })).sort((a, b) => b.answeredAt - a.answeredAt);
            const latestAnswerTime = sortedAnswers[0].answeredAt;
            if (lastWatermark) {
              const lastTime = new Date(lastWatermark).getTime();
              const newAnswers = sortedAnswers.filter(a => a.answeredAt > lastTime);
              if (newAnswers.length > 0) await load();
            }
            localStorage.setItem('last_answered_at', new Date(latestAnswerTime).toISOString());
          }
        } catch {}
      }

      document.getElementById('refreshBtn').addEventListener('click', load);
      document.getElementById('testNotifyBtn').addEventListener('click', async () => {
        if (Notification.permission !== 'granted') await Notification.requestPermission();
        await showNotification('í…ŒìŠ¤íŠ¸ ì•Œë¦¼', 'ì•Œë¦¼ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤!', 'test');
        App.toast('ì•Œë¦¼ì„ ë„ì› ìŠµë‹ˆë‹¤!', 'success');
      });
      document.getElementById('resetWatermarkBtn').addEventListener('click', () => {
        localStorage.removeItem('last_answered_at');
        App.toast('ì›Œí„°ë§ˆí¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      });
      document.getElementById('notifyBtn').addEventListener('click', async () => {
        const p = await Notification.requestPermission();
        if (p !== 'granted') { App.toast('ì•Œë¦¼ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error'); return; }
        await subscribeToPush();
        App.toast('ì•Œë¦¼ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤!', 'success');
        try {
          const items = await App.apiFetch('/me/suggestions');
          const answered = items.filter((s) => s.status === 'answered' && s.answered_at);
          if (answered.length > 0) {
            const maxTime = answered.map(s => new Date(s.answered_at).getTime()).sort((a, b) => b - a)[0];
            localStorage.setItem('last_answered_at', new Date(maxTime).toISOString());
          } else {
            localStorage.setItem('last_answered_at', new Date().toISOString());
          }
        } catch {}
      });

      load();
      setInterval(pollNewAnswers, 5000);
      pollNewAnswers();
    </script>
  </body>
</html>
