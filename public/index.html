<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>화홍고 학생회 건의함</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Pretendard', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'],
            },
            colors: {
              hwahong: {
                50:  '#eff6ff',
                100: '#dbeafe',
                500: '#1d4ed8',
                600: '#1e40af',
                700: '#1e3a8a',
                800: '#1e3380',
                900: '#172554',
              }
            }
          },
        },
      };
    </script>
    <link rel="stylesheet" href="/assets/theme.css" />
    <style>
      .hero-bg {
        background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 60%, #2563eb 100%);
      }
      .float-in { animation: floatIn 0.4s ease both; }
      @keyframes floatIn {
        from { opacity: 0; transform: translateY(16px); }
        to   { opacity: 1; transform: translateY(0); }
      }
    </style>
  </head>
  <body class="font-sans bg-slate-50 min-h-screen">

    <!-- 헤더 -->
    <header class="sticky top-0 z-40 backdrop-blur bg-white/90 border-b border-slate-200 shadow-sm">
      <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
        <a href="/" class="flex items-center gap-3 group">
          <img src="/assets/logo.png" alt="화홍고 로고" class="h-10 w-10 object-contain group-hover:scale-105 transition" />
          <div>
            <div class="text-sm font-bold text-slate-900 leading-none">화홍고등학교 학생회</div>
            <div class="text-xs text-blue-700 mt-0.5 font-medium">건의함</div>
          </div>
        </a>
        <nav class="flex items-center gap-1">
          <a href="/me.html" class="px-3 py-2 rounded-xl text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-700 transition font-medium">내 건의</a>
          <a href="/admin/login.html" class="px-3 py-2 rounded-xl text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-700 transition font-medium">관리자</a>
        </nav>
      </div>
    </header>

    <!-- 히어로 배너 -->
    <div class="hero-bg text-white py-10 px-4">
      <div class="max-w-5xl mx-auto flex items-center gap-6">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight">학생 건의함</h1>
          <p class="text-blue-100 mt-1 text-sm md:text-base">화홍고등학교 학생회에 의견을 전달하세요. 익명으로 작성할 수 있어요.</p>
        </div>
      </div>
    </div>

    <main class="max-w-5xl mx-auto px-4 py-8">
      <section class="float-in">

        <!-- 식별키 표시 -->
        <div class="mb-6 rounded-2xl bg-white shadow-sm ring-1 ring-slate-200 px-5 py-3 flex items-center justify-between gap-4 flex-wrap">
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500">내 식별키</span>
            <span id="studentKey" class="text-xs font-mono text-slate-700 select-all bg-slate-50 px-2 py-1 rounded-lg"></span>
          </div>
          <span class="text-xs text-slate-400">이 키로 내 건의를 확인할 수 있어요.</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- 건의 작성 폼 -->
          <div class="md:col-span-2 rounded-3xl bg-white shadow-md ring-1 ring-slate-200 overflow-hidden">
            <div class="px-6 py-5 border-b border-slate-100 bg-gradient-to-r from-blue-50 to-white">
              <div class="text-sm font-bold text-slate-900">새 건의 작성</div>
              <div class="text-xs text-slate-500 mt-1">학년 선택 후 제목과 내용을 작성해 주세요.</div>
            </div>

            <form id="form" class="px-6 py-6 space-y-5">
              <div>
                <div class="text-sm font-semibold text-slate-800 mb-3">학년</div>
                <div class="grid grid-cols-3 gap-2" id="gradeGrid"></div>
                <input type="hidden" id="grade" value="1" />
              </div>

              <div>
                <label class="text-sm font-semibold text-slate-800" for="title">제목</label>
                <input id="title" required minlength="2" maxlength="140"
                  class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-300 transition"
                  placeholder="예) 급식 메뉴 개선 요청" />
              </div>

              <div>
                <label class="text-sm font-semibold text-slate-800" for="content">내용</label>
                <textarea id="content" required minlength="5" maxlength="10000" rows="7"
                  class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-300 transition"
                  placeholder="불편했던 점, 개선 아이디어, 기대 효과 등을 자유롭게 적어주세요."></textarea>
              </div>

              <div class="flex items-center justify-between gap-4 flex-wrap pt-1">
                <a href="/me.html" class="text-sm text-blue-600 hover:text-blue-800 transition font-medium">내가 쓴 건의 보기 →</a>
                <button id="submitBtn" type="submit"
                  class="inline-flex items-center justify-center px-6 py-3 rounded-2xl bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold shadow-sm hover:shadow-md hover:-translate-y-0.5 transition duration-200">
                  제출하기
                </button>
              </div>
            </form>
          </div>

          <!-- 사이드바 -->
          <aside class="space-y-5">
            <div class="rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-6">
              <div class="text-sm font-bold text-slate-900">답변 알림</div>
              <p class="text-sm text-slate-600 mt-2 leading-relaxed">답변이 달리면 브라우저 알림으로 알려드려요.</p>
              <button id="notifyBtn"
                class="mt-4 w-full px-4 py-3 rounded-2xl bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold shadow-sm hover:shadow-md transition">
                알림 설정하기
              </button>
              <div id="notifyState" class="text-xs text-slate-400 mt-3"></div>
            </div>

            <div class="rounded-3xl bg-blue-800 text-white shadow-md p-6">
              <div class="text-sm font-bold flex items-center gap-2">
                <img src="/assets/logo.png" alt="" class="h-5 w-5 object-contain opacity-80" />
                화홍고 건의함 운영 원칙
              </div>
              <ul class="mt-3 text-sm text-blue-100 space-y-2 leading-relaxed">
                <li>• 욕설·비방·개인정보는 삭제될 수 있어요.</li>
                <li>• 좋은 제안은 실제로 반영됩니다!</li>
              </ul>
            </div>
          </aside>
        </div>
      </section>
    </main>

    <footer class="mt-12 py-6 border-t border-slate-200 text-center text-xs text-slate-400">
      <div class="flex items-center justify-center gap-3">
        <span>© 화홍고등학교 학생회 · 건의함</span>
    
        <a href="https://www.instagram.com/hwahonghigh_official"
           target="_blank"
           class="flex items-center gap-1 text-pink-600 hover:text-pink-700 font-medium transition">
           
          <!-- 인스타 SVG 아이콘 -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.75 2C4.57 2 2 4.57 2 7.75v8.5C2 19.43 4.57 22 7.75 22h8.5C19.43 22 22 19.43 22 16.25v-8.5C22 4.57 19.43 2 16.25 2h-8.5zm0 1.5h8.5A4.25 4.25 0 0120.5 7.75v8.5a4.25 4.25 0 01-4.25 4.25h-8.5A4.25 4.25 0 013.5 16.25v-8.5A4.25 4.25 0 017.75 3.5zm4.25 3.25a5.25 5.25 0 100 10.5 5.25 5.25 0 000-10.5zm0 1.5a3.75 3.75 0 110 7.5 3.75 3.75 0 010-7.5zm4.5-.88a1.12 1.12 0 100 2.25 1.12 1.12 0 000-2.25z"/>
          </svg>
    
          Instagram
        </a>
      </div>
    </footer>    

    <script src="/assets/app.js"></script>
    <script>
      const gradeGrid = document.getElementById('gradeGrid');
      const gradeInput = document.getElementById('grade');
      const studentKeyEl = document.getElementById('studentKey');
      const notifyBtn = document.getElementById('notifyBtn');
      const notifyState = document.getElementById('notifyState');
      const savedNotificationEmailKey = 'saved_notification_email';

      studentKeyEl.textContent = App.getStudentKey();

      const VAPID_PUBLIC_KEY = 'BJpbfzPQdhyWeK9lv9Rs6S3bdqYZpgAUqTuw6j0-ME2sxXWM8THv4d1ZCow2BtjPoULAqJb5yy86mPkXly0Fqpc';

      let swRegistration = null;
      let isPushSubscribed = false;
      const canUseNotifications = App.supportsNotifications();
      const canUsePush = App.supportsPushNotifications();

      if (canUsePush) {
        navigator.serviceWorker.register('/sw.js')
          .then((reg) => {
            swRegistration = reg;
            reg.pushManager.getSubscription().then((sub) => {
              if (sub) { isPushSubscribed = true; updateNotifyState(); }
            });
          })
          .catch((err) => console.log('SW 등록 실패:', err));
      }

      async function setupPushNotification() {
        if (!canUsePush || !swRegistration) { App.toast('이 브라우저에서는 알림을 지원하지 않습니다.', 'error'); return false; }
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') { App.toast('알림 권한이 필요합니다.', 'error'); return false; }
        try {
          const sub = await swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          await App.apiFetch('/push/subscribe', {
            method: 'POST',
            body: { endpoint: sub.endpoint, p256dh: arrayBufferToBase64Url(sub.getKey('p256dh')), auth: arrayBufferToBase64Url(sub.getKey('auth')) }
          });
          isPushSubscribed = true;
          updateNotifyState();
          App.toast('알림 설정 완료! 답변이 오면 알려드릴게요.', 'success');
          return true;
        } catch (e) {
          App.toast('알림 설정에 실패했습니다.', 'error');
          return false;
        }
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      function arrayBufferToBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      function getSavedNotificationEmail() {
        return localStorage.getItem(savedNotificationEmailKey) || '';
      }

      function saveNotificationEmail(email) {
        localStorage.setItem(savedNotificationEmailKey, email.trim().toLowerCase());
      }

      function maskEmail(email) {
        const [local, domain] = email.split('@');
        if (!local || !domain) return email;
        if (local.length <= 2) return `${local[0] || ''}*@${domain}`;
        return `${local.slice(0, 2)}${'*'.repeat(Math.max(1, local.length - 2))}@${domain}`;
      }

      function renderGrades(selected) {
        gradeGrid.innerHTML = '';
        for (let g = 1; g <= 3; g++) {
          const active = g === selected;
          const btn = App.el('button', {
            type: 'button',
            class: `px-3 py-3 rounded-2xl text-sm font-bold ring-1 transition shadow-sm hover:shadow-md hover:-translate-y-0.5 ${active ? 'bg-blue-700 text-white ring-blue-700' : 'bg-white text-slate-700 ring-slate-200 hover:bg-blue-50 hover:ring-blue-200'}`,
            onclick: () => { gradeInput.value = String(g); renderGrades(g); }
          }, [`${g}학년`]);
          gradeGrid.appendChild(btn);
        }
      }
      renderGrades(1);

      function updateNotifyState() {
        if (!canUseNotifications) {
          notifyState.textContent = '이 브라우저에서는 알림을 지원하지 않아요.';
          notifyBtn.textContent = '알림 미지원';
          notifyBtn.disabled = true;
          notifyBtn.classList.add('opacity-60', 'cursor-not-allowed');
          return;
        }
        const p = Notification.permission;
        if (p === 'granted' && isPushSubscribed) {
          notifyState.textContent = '알림이 활성화되었습니다!';
          notifyBtn.textContent = '알림 설정 완료 ✓';
          notifyBtn.classList.add('opacity-60', 'cursor-not-allowed');
        } else if (p === 'denied') {
          notifyState.textContent = '브라우저에서 알림이 차단되어 있어요.';
          notifyBtn.textContent = '알림 차단됨';
        } else {
          notifyState.textContent = '답변이 오면 알림을 받아보세요!';
          notifyBtn.textContent = '알림 설정하기';
        }
      }
      updateNotifyState();

      notifyBtn.addEventListener('click', async () => {
        if (!canUseNotifications) { App.toast('이 브라우저에서는 알림을 지원하지 않습니다.', 'info'); return; }
        if (Notification.permission === 'granted' && isPushSubscribed) { App.toast('이미 알림이 설정되어 있습니다.', 'info'); return; }
        await setupPushNotification();
      });

      document.getElementById('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-60');
        const payload = {
          grade: Number(document.getElementById('grade').value),
          title: document.getElementById('title').value,
          content: document.getElementById('content').value,
        };
        try {
          const createdSuggestion = await App.apiFetch('/suggestions', { method: 'POST', body: payload });
          document.getElementById('title').value = '';
          document.getElementById('content').value = '';
          if (!canUseNotifications || Notification.permission !== 'granted' || !isPushSubscribed) {
            const overlay = App.el('div', { class: 'fixed inset-0 z-50 bg-slate-950/40 backdrop-blur-sm flex items-center justify-center p-4' });
            const card = App.el('div', { class: 'w-full max-w-md rounded-3xl bg-white shadow-xl ring-1 ring-slate-200 overflow-hidden' });
            const head = App.el('div', { class: 'px-6 py-5 border-b border-slate-100 bg-blue-50' }, [
              App.el('div', { class: 'text-base font-bold text-slate-900' }, ['✅ 제출 완료']),
              App.el('div', { class: 'text-sm text-slate-500 mt-1' }, ['건의가 정상적으로 등록되었습니다!']),
            ]);
            const body = App.el('div', { class: 'px-6 py-5 text-sm text-slate-700 leading-relaxed space-y-4' });
            body.appendChild(App.el('div', {}, ['"내 건의" 페이지에서 진행 상태와 답변을 확인할 수 있어요.']));
            let emailInput = null;
            if (!canUseNotifications) {
              const savedNotificationEmail = getSavedNotificationEmail();
              body.appendChild(App.el('div', { class: 'rounded-2xl bg-slate-50 ring-1 ring-slate-200 p-4 space-y-3' }, [
                App.el('div', { class: 'text-sm font-semibold text-slate-900' }, ['이 브라우저에서는 알림이 지원되지 않아요.']),
                App.el('div', { class: 'text-xs text-slate-500' }, ['원하면 이메일 주소를 남기면 답변 등록 시 메일로 알려드릴게요.']),
              ]));
              if (savedNotificationEmail) {
                const savedEmailWrap = App.el('div', { class: 'rounded-2xl bg-white ring-1 ring-blue-100 p-3 flex items-center justify-between gap-3 flex-wrap' });
                savedEmailWrap.append(
                  App.el('div', { class: 'text-xs text-slate-500' }, ['이전에 사용한 이메일']),
                  App.el('button', {
                    type: 'button',
                    class: 'px-3 py-2 rounded-2xl bg-blue-50 text-blue-700 text-sm font-semibold hover:bg-blue-100 transition',
                  }, [`이전 이메일 사용 (${maskEmail(savedNotificationEmail)})`]),
                );
                body.appendChild(savedEmailWrap);
                savedEmailWrap.querySelector('button').addEventListener('click', () => {
                  if (emailInput) {
                    emailInput.value = savedNotificationEmail;
                    emailInput.focus();
                    emailInput.setSelectionRange(emailInput.value.length, emailInput.value.length);
                  }
                });
              }
              emailInput = App.el('input', {
                type: 'email',
                inputmode: 'email',
                placeholder: '이메일 주소',
                class: 'w-full rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-300 transition',
              });
              body.appendChild(emailInput);
            } else {
              body.appendChild(App.el('div', {}, ['답변이 오면 바로 알려드릴까요?']));
            }
            const foot = App.el('div', { class: 'px-6 py-5 bg-slate-50 flex items-center justify-end gap-2 flex-wrap' });
            const cancelBtn = App.el('button', { class: 'px-4 py-2 rounded-2xl bg-white ring-1 ring-slate-200 text-sm font-semibold hover:bg-slate-50 transition' }, ['나중에']);
            cancelBtn.addEventListener('click', () => overlay.remove());
            foot.append(cancelBtn);
            if (!canUseNotifications) {
              const emailBtn = App.el('button', { class: 'px-4 py-2 rounded-2xl bg-blue-700 text-white text-sm font-bold shadow-sm hover:bg-blue-800 transition' }, ['이메일로 받기']);
              emailBtn.addEventListener('click', async () => {
                if (!emailInput || !emailInput.value.trim()) {
                  App.toast('이메일 주소를 입력해 주세요.', 'error');
                  return;
                }
                if (!emailInput.checkValidity()) {
                  App.toast('유효한 이메일 주소를 입력해 주세요.', 'error');
                  return;
                }
                emailBtn.disabled = true;
                emailBtn.classList.add('opacity-60');
                try {
                  await App.apiFetch(`/me/suggestions/${createdSuggestion.id}/notification-email`, {
                    method: 'PATCH',
                    body: { email: emailInput.value.trim() }
                  });
                  saveNotificationEmail(emailInput.value);
                  overlay.remove();
                  App.openModal({ title: '이메일 등록 완료', message: '답변이 등록되면 이메일로 알려드릴게요.' });
                } catch (err) {
                  App.toast(err.message || '이메일 등록 실패', 'error');
                } finally {
                  emailBtn.disabled = false;
                  emailBtn.classList.remove('opacity-60');
                }
              });
              foot.append(emailBtn);
            } else {
              const confirmBtn = App.el('button', { class: 'px-4 py-2 rounded-2xl bg-blue-700 text-white text-sm font-bold shadow-sm hover:bg-blue-800 transition' }, ['알림 설정']);
              confirmBtn.addEventListener('click', () => { overlay.remove(); setupPushNotification(); });
              foot.append(confirmBtn);
            }
            card.append(head, body, foot);
            overlay.append(card);
            document.body.append(overlay);
          } else {
            App.openModal({ title: '✅ 제출 완료', message: '건의가 정상적으로 등록되었습니다!\n\n답변이 오면 바로 알려드릴게요.' });
          }
        } catch (err) {
          App.toast(err.message || '제출 실패', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-60');
        }
      });
    </script>
  </body>
</html>
