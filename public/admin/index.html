<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>í™”í™ê³  í•™ìƒíšŒ ê±´ì˜í•¨ - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ['Pretendard', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'] } } },
      };
    </script>
    <link rel="stylesheet" href="/assets/theme.css" />
    <style>
      body.admin-page {
        background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      }
      .hero-bg { background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 60%, #2563eb 100%); }
      .float-in { animation: floatIn 0.4s ease both; }
      @keyframes floatIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body class="admin-page font-sans min-h-screen">

    <!-- í—¤ë” -->
    <header class="sticky top-0 z-40 backdrop-blur bg-white/90 border-b border-slate-200 shadow-sm">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="/assets/logo.png" alt="í™”í™ê³  ë¡œê³ " class="h-10 w-10 object-contain" />
          <div>
            <div class="text-sm font-bold text-slate-900 leading-none">í™”í™ê³ ë“±í•™êµ í•™ìƒíšŒ</div>
            <div class="text-xs text-blue-700 mt-0.5 font-medium" id="adminMeta">ì¸ì¦ í™•ì¸ ì¤‘...</div>
          </div>
        </div>
        <nav class="flex items-center gap-1">
          <a href="/" class="px-3 py-2 rounded-xl text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-700 transition font-medium">í•™ìƒ í™”ë©´</a>
          <button id="logoutBtn" class="px-3 py-2 rounded-xl text-sm text-slate-600 hover:bg-red-50 hover:text-red-600 transition font-medium">ë¡œê·¸ì•„ì›ƒ</button>
        </nav>
      </div>
    </header>

    <!-- íˆì–´ë¡œ ë°°ë„ˆ -->
    <div class="hero-bg text-white py-10 px-4">
      <div class="max-w-6xl mx-auto flex items-center gap-6">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight">ê±´ì˜ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
          <p class="text-blue-100 mt-1 text-sm md:text-base">í•™ìƒ ê±´ì˜ë¥¼ í™•ì¸í•˜ê³  ë‹µë³€ì„ ì‘ì„±í•˜ì„¸ìš”.</p>
        </div>
      </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <section class="float-in">

        <!-- í•„í„° / ê²€ìƒ‰ -->
        <div class="bg-white rounded-3xl shadow-md ring-1 ring-slate-200 p-5 mb-6">
          <div class="flex items-center gap-3 flex-wrap justify-between">
            <div class="flex items-center gap-2 flex-wrap">
              <div class="text-sm font-bold text-slate-800">í•™ë…„</div>
              <div class="flex flex-wrap gap-2" id="gradeFilters"></div>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <button id="adminNotifyBtn"
                class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-bold shadow-sm transition">
                ğŸ”” ì•Œë¦¼ ì„¤ì •
              </button>
              <input id="q" placeholder="ì œëª©/ë‚´ìš© ê²€ìƒ‰"
                class="w-48 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-300 transition" />
              <select id="status"
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100 transition">
                <option value="">ì „ì²´ ìƒíƒœ</option>
                <option value="pending">ëŒ€ê¸°ì¤‘</option>
                <option value="answered">ë‹µë³€ì™„ë£Œ</option>
              </select>
              <button id="refreshBtn"
                class="px-4 py-2 rounded-xl bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold shadow-sm transition">
                ì¡°íšŒ
              </button>
            </div>
          </div>
        </div>

        <div id="list" class="grid grid-cols-1 gap-5"></div>
      </section>
    </main>

    <footer class="mt-12 py-6 border-t border-slate-200 text-center text-xs text-slate-400">
      Â© í™”í™ê³ ë“±í•™êµ í•™ìƒíšŒ Â· ê´€ë¦¬ì ì½˜ì†”
    </footer>

    <script src="/assets/app.js"></script>
    <script>
      const token = localStorage.getItem('admin_token');
      if (!token) location.href = '/admin/login.html';

      const VAPID_PUBLIC_KEY = 'BJpbfzPQdhyWeK9lv9Rs6S3bdqYZpgAUqTuw6j0-ME2sxXWM8THv4d1ZCow2BtjPoULAqJb5yy86mPkXly0Fqpc';

      function adminFetch(path, opts = {}) {
        return App.apiFetch(path, { ...opts, headers: { ...(opts.headers || {}), Authorization: 'Bearer ' + token } });
      }

      let swRegistration = null;
      let isPushSubscribed = false;

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then((reg) => {
            swRegistration = reg;
            reg.pushManager.getSubscription().then((sub) => {
              if (sub) { isPushSubscribed = true; updateAdminNotifyButton(); }
            });
          })
          .catch((err) => console.log('SW ë“±ë¡ ì‹¤íŒ¨:', err));
      }

      function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
        return outputArray;
      }

      function arrayBufferToBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      async function setupAdminPush() {
        if (!swRegistration) { App.toast('í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì˜ˆìš”.', 'error'); return; }
        const permission = await Notification.requestPermission();
        if (permission !== 'granted') { App.toast('ì•Œë¦¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error'); return; }
        try {
          const sub = await swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          await adminFetch('/push/admin/subscribe', {
            method: 'POST',
            body: { endpoint: sub.endpoint, p256dh: arrayBufferToBase64Url(sub.getKey('p256dh')), auth: arrayBufferToBase64Url(sub.getKey('auth')) }
          });
          isPushSubscribed = true;
          updateAdminNotifyButton();
          App.toast('ê´€ë¦¬ì ì•Œë¦¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } catch (e) {
          App.toast('ì•Œë¦¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      }

      function updateAdminNotifyButton() {
        const btn = document.getElementById('adminNotifyBtn');
        if (isPushSubscribed) {
          btn.textContent = 'ğŸ”” ì•Œë¦¼ ì„¤ì • ì™„ë£Œ âœ“';
          btn.classList.add('opacity-60', 'cursor-not-allowed');
        } else {
          btn.textContent = 'ğŸ”” ì•Œë¦¼ ì„¤ì •';
        }
      }

      document.getElementById('adminNotifyBtn').addEventListener('click', () => {
        if (isPushSubscribed) { App.toast('ì´ë¯¸ ì•Œë¦¼ì´ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'info'); return; }
        setupAdminPush();
      });

      const adminMeta = document.getElementById('adminMeta');
      const listEl = document.getElementById('list');
      const gradeFilters = document.getElementById('gradeFilters');
      let selectedGrade = '';

      function fmt(dt) {
        try { return new Date(dt).toLocaleString('ko-KR', { hour12: false }); } catch { return String(dt); }
      }

      function badge(status) {
        const cls = status === 'answered' ? 'bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200' : 'bg-amber-50 text-amber-700 ring-1 ring-amber-200';
        const label = status === 'answered' ? 'âœ“ ë‹µë³€ì™„ë£Œ' : 'â³ ëŒ€ê¸°ì¤‘';
        return App.el('span', { class: `px-3 py-1 rounded-full text-xs font-semibold ${cls}` }, [label]);
      }

      function renderGradeFilters() {
        gradeFilters.innerHTML = '';
        const allBtn = App.el('button', {
          type: 'button',
          class: `px-3 py-2 rounded-xl text-sm font-bold ring-1 transition ${selectedGrade === '' ? 'bg-blue-700 text-white ring-blue-700' : 'bg-white text-slate-700 ring-slate-200 hover:bg-blue-50 hover:ring-blue-200'}`,
          onclick: () => { selectedGrade = ''; renderGradeFilters(); load(); },
        }, ['ì „ì²´']);
        gradeFilters.appendChild(allBtn);
        for (let g = 1; g <= 3; g++) {
          const active = String(g) === selectedGrade;
          const btn = App.el('button', {
            type: 'button',
            class: `px-3 py-2 rounded-xl text-sm font-bold ring-1 transition ${active ? 'bg-blue-700 text-white ring-blue-700' : 'bg-white text-slate-700 ring-slate-200 hover:bg-blue-50 hover:ring-blue-200'}`,
            onclick: () => { selectedGrade = String(g); renderGradeFilters(); load(); },
          }, [`${g}í•™ë…„`]);
          gradeFilters.appendChild(btn);
        }
      }

      function itemCard(s) {
        const wrap = App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 overflow-hidden hover:shadow-lg transition' });
        const hasAnswer = Boolean((s.answer || '').trim());
        const canEditAnswered = s.status === 'answered' && hasAnswer;
        const delBtn = App.el('button', {
          class: 'px-3 py-1.5 rounded-xl bg-white ring-1 ring-red-200 text-red-500 hover:bg-red-50 hover:ring-red-400 text-xs font-bold transition',
        }, ['ì‚­ì œ']);
        delBtn.addEventListener('click', async () => {
          if (!confirm('ê±´ì˜ë¥¼ ì™„ì „íˆ ì‚­ì œí• ê¹Œìš”? ë³µêµ¬í•  ìˆ˜ ì—†ì–´ìš”.')) return;
          delBtn.disabled = true;
          try {
            await adminFetch(`/admin/suggestions/${s.id}`, { method: 'DELETE' });
            App.toast('ê±´ì˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await load();
          } catch (err) {
            App.toast(err.message || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
            delBtn.disabled = false;
          }
        });

        const headRight = App.el('div', { class: 'flex items-center gap-2 shrink-0' });
        const editBtn = canEditAnswered ? App.el('button', {
          class: 'px-3 py-1.5 rounded-xl bg-white ring-1 ring-blue-200 text-blue-700 hover:bg-blue-50 hover:ring-blue-400 text-xs font-bold transition',
          type: 'button',
        }, ['ë‹µë³€ìˆ˜ì •']) : null;
        if (editBtn) headRight.append(badge(s.status), editBtn, delBtn);
        else headRight.append(badge(s.status), delBtn);

        const head = App.el('div', { class: 'px-6 py-5 border-b border-slate-100 flex items-start justify-between gap-4' }, [
          App.el('div', {}, [
            App.el('div', { class: 'text-xs text-slate-400' }, [`#${s.id} Â· ${s.grade}í•™ë…„ Â· ${fmt(s.created_at)}`]),
            App.el('div', { class: 'text-lg font-bold text-slate-900 mt-1' }, [s.title]),
          ]),
          headRight,
        ]);
        const body = App.el('div', { class: 'px-6 py-5 text-sm text-slate-700 leading-relaxed whitespace-pre-wrap' }, [s.content]);

        const answerBox = App.el('div', { class: 'px-6 py-5 bg-blue-50 border-t border-blue-100' });
        answerBox.appendChild(App.el('div', { class: 'text-sm font-bold text-blue-900' }, ['ğŸ’¬ ë‹µë³€ ì‘ì„±']));
        answerBox.appendChild(App.el('div', { class: 'text-xs text-blue-500 mt-1' }, ['ì €ì¥í•˜ë©´ ìë™ìœ¼ë¡œ ë‹µë³€ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ë©ë‹ˆë‹¤.']));

        const ta = App.el('textarea', {
          class: 'mt-3 w-full rounded-2xl border border-blue-200 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-300 transition',
          rows: '5',
          placeholder: 'ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...',
        }, [s.answer || '']);

        const saveBtn = App.el('button', {
          class: 'mt-3 px-5 py-3 rounded-2xl bg-blue-700 hover:bg-blue-800 text-white text-sm font-bold shadow-sm hover:shadow-md transition',
        }, ['ë‹µë³€ ì €ì¥']);

        function lockAnswerEditor() {
          ta.readOnly = true;
          ta.classList.add('bg-slate-100', 'text-slate-500', 'cursor-not-allowed', 'pointer-events-none');
          saveBtn.classList.add('hidden');
        }

        function unlockAnswerEditor() {
          ta.readOnly = false;
          ta.classList.remove('bg-slate-100', 'text-slate-500', 'cursor-not-allowed', 'pointer-events-none');
          saveBtn.classList.remove('hidden');
          saveBtn.textContent = 'ë‹µë³€ ìˆ˜ì • ì €ì¥';
        }

        if (canEditAnswered) {
          lockAnswerEditor();
          editBtn.addEventListener('click', () => {
            unlockAnswerEditor();
            ta.focus();
          });
        }

        saveBtn.addEventListener('click', async () => {
          saveBtn.disabled = true; saveBtn.classList.add('opacity-60');
          try {
            await adminFetch(`/admin/suggestions/${s.id}/answer`, { method: 'PATCH', body: { answer: ta.value } });
            App.toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            await load();
          } catch (err) {
            App.toast(err.message || 'ì €ì¥ ì‹¤íŒ¨', 'error');
          } finally { saveBtn.disabled = false; saveBtn.classList.remove('opacity-60'); }
        });

        answerBox.append(ta, saveBtn);
        wrap.append(head, body, answerBox);
        return wrap;
      }

      async function load() {
        listEl.innerHTML = '<div class="text-sm text-slate-400 py-4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        const params = new URLSearchParams();
        if (selectedGrade) params.set('grade', selectedGrade);
        const status = document.getElementById('status').value;
        if (status) params.set('status', status);
        const q = document.getElementById('q').value.trim();
        if (q) params.set('q', q);
        try {
          const items = await adminFetch('/admin/suggestions' + (params.toString() ? '?' + params.toString() : ''));
          listEl.innerHTML = '';
          if (!items.length) {
            listEl.appendChild(App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-10 text-center' }, [
              App.el('div', { class: 'text-4xl mb-4' }, ['ğŸ“­']),
              App.el('div', { class: 'text-lg font-bold text-slate-900' }, ['ì¡°ê±´ì— ë§ëŠ” ê±´ì˜ê°€ ì—†ì–´ìš”.']),
              App.el('div', { class: 'text-sm text-slate-500 mt-2' }, ['í•„í„°ë¥¼ ë³€ê²½í•´ ë³´ì„¸ìš”.']),
            ]));
            return;
          }
          items.forEach((s) => listEl.appendChild(itemCard(s)));
        } catch (err) {
          if (err.status === 401) { localStorage.removeItem('admin_token'); location.href = '/admin/login.html'; return; }
          listEl.innerHTML = '';
          listEl.appendChild(App.el('div', { class: 'rounded-3xl bg-white shadow-md ring-1 ring-slate-200 p-6 text-sm text-slate-600' }, [err.message || 'API ì˜¤ë¥˜']));
        }
      }

      document.getElementById('refreshBtn').addEventListener('click', load);
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('admin_token');
        location.href = '/admin/login.html';
      });

      (async () => {
        try {
          const me = await adminFetch('/admin/me');
          adminMeta.textContent = `ë¡œê·¸ì¸: ${me.username}`;
        } catch {
          localStorage.removeItem('admin_token');
          location.href = '/admin/login.html';
        }
      })();

      renderGradeFilters();
      load();
    </script>
  </body>
</html>
